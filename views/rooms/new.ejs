<%- include('../_layout_top') %>
<div class="max-w-lg mx-auto card">
  <h2 class="text-lg font-medium mb-4">Crear cuarto</h2>
  <form action="/rooms" method="post" class="space-y-3">
    <div>
      <label class="block text-sm text-gray-700">Casa</label>
      <select name="house_id" id="house_id" class="w-full border rounded px-3 py-2">
        <option value="">Seleccione una casa</option>
        <% houses.forEach(h => { %>
          <option value="<%= h.id %>"><%= h.name %></option>
        <% }) %>
      </select>
    </div>
    <div>
      <label class="block text-sm text-gray-700">Piso (número)</label>
      <select name="floor_id" id="floor_id" class="w-full border rounded px-3 py-2" required>
        <option value="">Seleccione una casa primero</option>
      </select>
    </div>
    <div>
      <label class="block text-sm text-gray-700">Número cuarto</label>
      <input class="w-full border rounded px-3 py-2" name="number" id="room_number" type="number" required>
    </div>
    <div>
      <label class="block text-sm text-gray-700">Código</label>
      <input class="w-full border rounded px-3 py-2" name="code" id="room_code" disabled>
    </div>
    <div>
      <label class="block text-sm text-gray-700">Tipo</label>
      <select name="room_type_id" class="w-full border rounded px-3 py-2">
        <% types.forEach(t => { %>
          <option value="<%= t.id %>"><%= t.name %></option>
        <% }) %>
      </select>
    </div>
    <div>
      <label class="block text-sm text-gray-700">Área m2</label>
      <input class="w-full border rounded px-3 py-2" name="area_m2" type="number" step="0.1">
    </div>
    <div>
      <button class="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2 btn-small" type="submit">
        <svg class="w-4 h-4" aria-hidden="true"><use href="#icon-plus" /></svg>
        Crear
      </button>
    </div>
  </form>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const houseSelect = document.getElementById('house_id');
      const floorSelect = document.getElementById('floor_id');
      const numberInput = document.getElementById('room_number');
      const codeInput = document.getElementById('room_code');

      function setCodeIfReady() {
        const house = houseSelect.value;
        const floor = floorSelect.value;
        const floorText = floorSelect.options[floorSelect.selectedIndex]?.text || '';
        const number = numberInput.value;
        if (house && floor && number) {
          codeInput.value = `C${house}-P${floorText}-C${number}`;
        }
      }

      houseSelect.addEventListener('change', function() {
        const houseId = this.value;
        floorSelect.innerHTML = '<option value="">Cargando...</option>';
        if (!houseId) {
          floorSelect.innerHTML = '<option value="">Seleccione una casa primero</option>';
          setCodeIfReady();
          return;
        }
        fetch(`/rooms/floors/${houseId}`)
          .then(res => res.json())
          .then(data => {
            if (data.length === 0) {
              floorSelect.innerHTML = '<option value="">No hay pisos</option>';
            } else {
              floorSelect.innerHTML = data.map(f => `<option value="${f.id}">${f.number}</option>`).join('');
            }
            setCodeIfReady();
          })
          .catch(() => {
            floorSelect.innerHTML = '<option value="">Error cargando pisos</option>';
            setCodeIfReady();
          });
      });
      floorSelect.addEventListener('change', setCodeIfReady);
      numberInput.addEventListener('input', setCodeIfReady);
    });
  </script>
</div>
<%- include('../_layout_bottom') %>
